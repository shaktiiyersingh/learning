
<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8"><meta property="fb:app_id"          content="1234567890" /> 
    <meta property="og:type"            content="article" /> 
    <meta property="og:url"             content="https://yosig.herokuapp.com/mytravelsignature.png" /> 
    <meta property="og:title"           content="Introducing our New Site" /> 
     
           <meta property="og:image"           content="https://yosig.herokuapp.com/mytravelsignature.png" /> 
    <meta property="og:description"    content="" />

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <title>Rotating 45� imagery</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="https://github.com/niklasvh/html2canvas/releases/download/0.4.1/html2canvas.js"></script>

        
    <style>
      /* Always set the map height explicitly to define the size of the div
      * element that contains the map. */
      #map {
        height: 80%;
        width:80%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #description {
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
      }

      #infowindow-content .title {
        font-weight: bold;
      }

      #infowindow-content {
        display: none;
      }

      #map #infowindow-content {
        display: inline;
      }
      .day{
        cursor:pointer;
        background: mintcream;
        height:70%;
        margin:7px;
        border:1px solid #aaa;
        padding:10px;
        width:200px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        font-family: Roboto;
        border-radius:10px;
      }
      .pac-card {
        margin: 10px 10px 0 0;
        border-radius: 2px 0 0 2px;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        outline: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        background-color: #fff;
        font-family: Roboto;
      }

      #pac-container {
        padding-bottom: 12px;
        margin-right: 12px;


      }

      .pac-controls {
        display: inline-block;
        padding: 5px 5px;
        margin-top:5px;
      }

      .pac-controls label {
        font-family: Roboto;
        font-size: 13px;
        font-weight: 300;
      }

      #pac-input {
        background-color: #fff;
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
        margin-left: 2%;
        padding: 0 11px 0 13px;
        text-overflow: ellipsis;
        width:80%;

      }

      #pac-input:focus {
        border-color: red;
      }

      #title {
        color: #fff;
        background-color: #4d90fe;
        font-size: 15px;
        font-weight: 500;
        padding: 6px 12px;
      }
      #floating-panel {
        position: absolute;
        top: 10px;
        left: 25%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        padding-left: 10px;
      }
    </style>
      
     <script async defer src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyCAt7tEIMKtzmSfjRYNY_M-0-8w1Ig8CuM&callback=initMap"
     type="text/javascript"></script>
  </head>
  <body>
   

    <div id="map" style='float:left;'></div>
    

    <div class="pac-card" id="pac-card">
      <div>
        <div id="title">
          Add your memorable travel destinations and create your travel signature
        </div>
        <div id="type-selector" class="pac-controls">
          <input type="radio" name="type" id="changetype-all" checked="checked">
          <label for="changetype-all">All</label>

          <input type="radio" name="type" id="changetype-establishment">
          <label for="changetype-establishment">Establishments</label>
          <!--
<input type="radio" name="type" id="changetype-address">
<label for="changetype-address">Addresses</label>

<input type="radio" name="type" id="changetype-geocode">
<label for="changetype-geocode">Geocodes</label>
-->
        </div>
        <div id="strict-bounds-selector" class="pac-controls">
          <input type="checkbox" id="use-strict-bounds" value="">
          <label for="use-strict-bounds">Strict Bounds</label>
        </div>
      </div>
      <div id="pac-container">
        <input id="pac-input" type="text"
               placeholder="Enter a location">
               <input id = "fbpost" type = "submit" value = "fbpost"/>
               
      </div>
    </div>
    <div id="postResultDiv">
       
        
      </div>
        <br>

    <div id="summary_box" style='float:left;border:1px solid #aaa; height:18%;width:99%;margin:5px;background:darkkhaki'>

    </div>

    <script>
      var marker_id=-1;
      var map;
      var markers = new Array();
      var curr_loc=0
      var info_windows =new Array();
      var info_window_html = ''; /*'<img src="" width="16" height="16" id="place-icon">';*/
      
      info_window_html +='<tr><td>words  </td><td colspan="3"><textarea id="place-details" class="pac-controls" style="width:300px" rows="2"></textarea>';
      info_window_html +='</td></tr><tr><td></td><td><input type="button" value="save" onclick="save_info_data();"/></td></tr></tr></table>';
     
      var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
      var icons = {
        hindu_temple: {
          icon: 'http://maps.google.com/mapfiles/kml/pal3/icon23.png'
        },	
        amusement_park: {
          icon: 'http://maps.google.com/mapfiles/kml/pal2/icon4.png'
        },
        aquarium: {
          icon: 'http://maps.google.com/mapfiles/kml/pal4/icon35.png'
        },
        zoo: {
          icon: 'http://maps.google.com/mapfiles/kml/pal5/icon1.png'
        },
        art_gallery: {
          icon: 'http://maps.google.com/mapfiles/kml/pal2/icon30.png'
        },
        shopping_mall: {
          icon: 'http://maps.google.com/mapfiles/kml/pal3/icon18.png'
        }
      };
      var last_place_search_type="";
      function SearchPlace(value){
        deleteNearByMarkers();
        if(value==""){
          return;
        }
        last_place_search_type=value;
        console.log("search called for:"+value);
        var kms=Number("0"+document.getElementById("search_radius").value)*1000;
        nearby_infowindow = new google.maps.InfoWindow();
        var service = new google.maps.places.PlacesService(map);
        service.nearbySearch({
          location: markers[marker_id].getPosition(),
          radius: kms,
          type: [value]
        }, PlaceCallback);
      }
      function PlaceCallback(results, status) {
        console.log("Search Results");
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          for (var i = 0; i < results.length; i++) {
            console.log(results[i]);
            createMarker(results[i]);
          }
        }
      }
      var nearby_infowindow;
      var nearbyMarkers=new Array();
      function createMarker(place) {
        var placeLoc = place.geometry.location;
        var icon="http://maps.google.com/mapfiles/ms/icons/blue-dot.png";

        if(last_place_search_type=="hindu_temple" || last_place_search_type=="aquarium" || last_place_search_type=="zoo" || last_place_search_type=="amusement_park" || last_place_search_type=="shopping_mall" || last_place_search_type=="art_gallery"){
          icon=icons[last_place_search_type].icon;
        }
        var marker = new google.maps.Marker({
          map: map,
          animation: google.maps.Animation.DROP,
          position: place.geometry.location,
          icon: {url:icon, scaledSize: new google.maps.Size(35, 35)}


        });
        google.maps.event.addListener(marker, 'click', function() {
          nearby_infowindow.setContent(place.name);
          nearby_infowindow.open(map, this);
        });
        marker.setVisible(true);
        nearbyMarkers.push(marker);
        /*
			google.maps.event.addListener(marker, 'click', function() {
				infowindow.setContent(place.name);
				infowindow.open(map, this);
			});
			*/
      }
     

      $("#fbpost").click(function(){
        var imgname;
    console.log("token "+ token);
    console.log("user" + userId);
  
    html2canvas($("#map"), {
          useCORS: true,
          optimized: false,
           allowTaint: false,
            onrendered: function(canvas) {
           //theCanvas = canvas;
              //  document.body.appendChild(canvas);
              //  $('body').append($('<img>').attr('src', canvas.toDataURL()));
              var win = window.open();
              win.document.write("<img src='"+canvas.toDataURL()+"'/>");
              var data = canvas.toDataURL("image/png");
              try {
             blob = dataURItoBlob(data);
             console.log(data);
               saveSignatureImage(userId,data);
              //console.log(imgname);
                 } catch (e) {
            console.log(e);
                   }

                
 
              
             // console.log(canvas);
          
            }
          });

});

function postImageToFacebook( imgname,token, filename, mimeType, imageData, message) {

      console.log("https://yosig.herokuapp.com/" + imgname);
    var fd = new FormData();
    fd.append("access_token", token);
    fd.append("source", imageData);
    fd.append("message", "yo");
    fd.append("no_story", true);
   
    
    FB.ui({
  method: 'share',
  href: "https://yosig.herokuapp.com/" + imgname,
}, function(response){});


//$.post("https://graph.facebook.com?id='https://yosig.herokuapp.com/mytravelsignature.png'&scrape=true");
/*
$.post(
    'https://graph.facebook.com',
    {
        id: 'https://yosig.herokuapp.com/mytravelsignature.png',
        scrape: true
    },
    function(response){
       console.log(response);
    }
);
*/

/*
FB.ui({
    method: 'share_open_graph',
    action_type: 'og.likes',
    action_properties: JSON.stringify({
        object : {
           'og:url': 'https://yosig.herokuapp.com/mytravelsignature.png',
           'og:title': 'travel signature',
           'og:description': 'memorable travels you remembered and marked in 30 seconds',
           
           'og:image': 'https://yosig.herokuapp.com/mytravelsignature.png'
        }
    }),
    scrape:true
  
});
   */
    /*
     FB.api('/me/photos', 'post', fd, function(response)
        {
            if (!response || response.error)
            {
                console.log(response.error);
                //alert('Posting error occured');
            }else{
                console.log('Success - Post ID: ' + response.id);
            }
        });
*/
   /*
    try {
   console.log("https://graph.facebook.com/me/photos?access_token=" + token);
        $.ajax({ 
            // "https://graph.facebook.com/me?fields=photos&access_token="+token,
          //url: "https://graph.facebook.com/v2.11/me/photos?accesstoken="+token,
        url: "https://graph.facebook.com/me/photos?access_token=" + token,
         
         
        
            type:"POST",
            data:fd,
            processData:false,
            contentType:false,
            cache:false,
            success:function(data){
                console.log("success " + data);

                    //console.log(response.images[0].source););
            },
            error:function(shr,status,data){
                console.log("error " + data + " Status " + shr.status);
            },
           
        });
    }
    catch(e) {
        console.log(e);
    }
    */
    // 
}
function dataURItoBlob(dataURI) {
    var byteString = atob(dataURI.split(',')[1]);
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab], {type: 'image/png'});
}
      function deleteNearByMarkers(){
        for (var i = 0; i < nearbyMarkers.length; i++) {
          nearbyMarkers[i].setMap(null);
        }
        nearbyMarkers=new Array();
      }

      var curr_day=0;

      var places = [
        {lat: 26.1050606, lng: 91.5810472,heading:"Arrival (12:30 PM)",text:"After arriving at the airport at Guwahati, a shuttle service at 1:00pm will transfer you from the airport to the main city, where you can have a complimentary lunch"},
        {lat: 25.670829, lng: 91.902708,heading:"Photography at Umiam Lake (01:45 PM)", text:"Once you�ve had your lunch, the drive to Shillong will commence, with an optional stopover enroute at a photography point where you can capture some pictures of the Umiam Lake"},
        {lat: 25.580880, lng: 91.886714,heading:"Hotel Checkin, Rest & Leisure (04:00 PM)",text:"When you arrive at Shillong, check into your hotel and relax for a bit before having your complimentary dinner and turning in for the night at your hotel in Shillong"}
      ];

      //window.setTimeout(play,2000);
   
      function save_info_data(){

        var info = {
                    
                    "details":document.getElementById('place-details').value,
                    "marker_id":marker_id,
                    "position":marker.position
                    
                   }
                   
        //console.log(info);
        info_windows.push(info);
        //console.log(marker_id);
        //console.log(markers[marker_id].getPosition())
        markers[marker_id].infowindow.close();
        
   
        //RecreateDays();

      }
      function RecreateDays(){
        var lastDay=0;
        var html="";
        for (var i = 0; i < info_windows.length; i++) {
          if(info_windows[i]["day"]!=lastDay){
            html+="<div class='day' id='_day_"+info_windows[i]["day"]+"_"+info_windows[i]["marker_id"]+"'>Day "+info_windows[i]["day"]+"<br>"+info_windows[i]["place"]+"</div>"
          }
        }
        document.getElementById("summary_box").innerHTML=html;
        console.log(html);
      }

      function play(){
        deleteMarkers();
        placeMarker(places[curr_loc]["lat"],places[curr_loc]["lng"],places[curr_loc]["heading"],places[curr_loc]["text"]);
        if(curr_loc==1){
          //showLine();
        }
        curr_loc+=1;
        //if(curr_loc<places.length){window.setTimeout(play,10000);}
        //readDays();
      }

      function readDays(){
        //alert(days[0]["head"]);
        //alert(days[0]["items"]);
      }

 var token;
 var userId;
 
 
      function initMap() {
  
    //if(response.status === 'connected'){console.log('connected');}
    var styles = {
        default: null,
        hide: [
          {
            featureType: 'administrative.country',
            elementType:'labels',
            stylers: [{visibility: 'off'}]
          },
          {
            featureType: 'administrative.land_parcel',
            elementType:'labels',
            stylers: [{visibility: 'off'}]
          },
          {
            featureType: 'administrative.locality',
            elementType:'labels',
            stylers: [{visibility: 'off'}]
          },
          {
            featureType: 'administrative.neighborhood',
            elementType:'labels',
            stylers: [{visibility: 'off'}]
          },
          {
            featureType: 'administrative.province',
            elementType:'labels',
            stylers: [{visibility: 'off'}]
          }
        
        ]
      };
   
  
        
    
  
 

    map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 25.960281, lng: 91.853323}, 
          zoom: 4,
          mapTypeId: google.maps.MapTypeId.HYBRID,
          heading: 90,
          tilt: 45
         
        });
        map.setOptions({styles: styles["hide"]});
//console.log(map.styles);
        var card = document.getElementById('pac-card');
        var input = document.getElementById('pac-input');
        var types = document.getElementById('type-selector');
        var strictBounds = document.getElementById('strict-bounds-selector');

        map.controls[google.maps.ControlPosition.TOP_RIGHT].push(card);

        
            //alert(markers.length);
      //showLine(markers);
        
        var autocomplete = new google.maps.places.Autocomplete(input);

        // Bind the map's bounds (viewport) property to the autocomplete object,
        // so that the autocomplete requests use the current map bounds for the
        // bounds option in the request.
        autocomplete.bindTo('bounds', map);
        /*
        var marker = new google.maps.Marker({
          map: map,
          anchorPoint: new google.maps.Point(0, -29)
        });
		*/
        autocomplete.addListener('place_changed', function() {
          //infowindow.close();
          //marker.setVisible(false);
          var place = autocomplete.getPlace();
          if (!place.geometry) {
            // User entered the name of a Place that was not suggested and
            // pressed the Enter key, or the Place Details request failed.
            window.alert("No details available for input: '" + place.name + "'");
            return;
          }

          // If the place has a geometry, then present it on a map.
          if (place.geometry.viewport) {
            //map.fitBounds(place.geometry.viewport);
          } else {
            //map.setCenter(place.geometry.location);
            //map.setZoom(9);  
          }
          PlaceMarker2(place.geometry.location, place.name);
        });

        //buildDays();
        
        window.fbAsyncInit = function() {
          FB.init({
            appId      : '1844649825572339',
            cookie     : true,
            xfbml      : true,
            version    : 'v3.1'
          });
           // console.log('initialized');
           
          
            



          FB.AppEvents.logPageView();   
          FB.login(function(response) {
            
      if (response.authResponse) {

        console.log('You are logged in &amp; cookie set!'); 
         //console.log(response.authResponse.access_token);
         token = response.authResponse.accessToken;
        
         FB.api('/me', {fields: 'first_name,last_name,email'}, function(response) {
           userId = response.id;
    console.log(userId);
    ajaxGetSignature(userId);
   
},{access_token:token});
      } 
      else {
        console.log('User cancelled login or did not fully authorize.');
      }
    },{scope: "user_photos, manage_pages,publish_pages"});




        };
      
        (function(d, s, id){
           var js, fjs = d.getElementsByTagName(s)[0];
           if (d.getElementById(id)) {return;}
           js = d.createElement(s); js.id = id;
           js.src = "https://connect.facebook.net/en_US/sdk.js";
           fjs.parentNode.insertBefore(js, fjs);
         }(document, 'script', 'facebook-jssdk'));
         
       
      }
function saveSignatureImage(userId, image)
{
 
 var imgname;
 var signatureImage = {"userId": userId,"image":image};
 
 $.ajax({
                type : "POST",
                contentType : "application/json",
                url : '/addSignatureImage',
                data : JSON.stringify(signatureImage),
                dataType : 'json',
                success : function(result) {
                          imgname = result.imgname;
                       //console.log(imgname);
                       retimgname(imgname);
                              
                },
                error : function(e) {
                 
                  console.log("ERROR: ", e);
                }
              });


}

function retimgname(imgname)
{
  //console.log(imgname);
  postImageToFacebook(imgname, token, "Canvas to Facebook", "image/png", blob, window.location.href);
 
}
      function PlaceMarker2(location,name){
        console.log(location + name);
        console.log(location.lat());
        console.log(location.lng());
        var dot = {"lat": location.lat(),"lng":location.lng(),"name":name};
        //get the statename
        var lat = "43.7667855" ;
        var long = "-79.2157321" ;
        var url = "https://maps.googleapis.com/maps/api/geocode/json?latlng="+location.lat()+","+location.lng()+"&sensor=false";
        console.log(url);
        $.ajax({
                type : "POST",
                contentType : "application/json",
                url : '/addDot',
                data : JSON.stringify(dot),
                dataType : 'json',
                success : function(dot) {
                          
                          $("#postResultDiv").html("<p>" + 
                    "Post Successfully! <br>" +
                              "--->" + JSON.stringify(dot)+ "</p>"); 
                              
                           
                },
                error : function(e) {
                  alert(e)

                  console.log("ERROR: ", e);
                }
              });
              ajaxGetSignature(userId);
        /*
		$.get(url).success(function(data) {
		   var loc1 = data.results[0];
		   var county, city;
			 $.each(loc1, function(k1,v1) {
				if (k1 == "address_components") {
				   for (var i = 0; i < v1.length; i++) {
					  for (k2 in v1[i]) {
						 if (k2 == "types") {
							var types = v1[i][k2];
							if (types[0] =="sublocality_level_1") {
								county = v1[i].long_name;
								//alert ("county: " + county);
							} 
							if (types[0] =="locality") {
							   city = v1[i].long_name;
							   //alert ("city: " + city);
						   } 
						 }

					  }          

				   }

				}

			 });
			 $('#city').html(city); 
		});
*/

        ///////////////////////
      

        var marker = new google.maps.Marker({
          position: location,
          label:
          {text: name,
          color: "#FFFFFF"},
          map: map,
          animation: google.maps.Animation.DROP,
          icon: {url:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png", scaledSize: new google.maps.Size(10, 10)},

        });
       
        /*
        google.maps.event.addListener(marker,'click',function() {
          var this_id=marker.get("id");
          markers[this_id].infowindow.open(map,markers[this_id]);
          /*
			console.log(markers[this_id].infowindow);
			var content = info_windows[this_id];
			console.log(content);
			var infowindow = new google.maps.InfoWindow({
			  content:content
			});
		    infowindow.open(map,marker);
			
        });
      */
        //marker.setPosition(place.geometry.location);
        
        
        marker.setVisible(true);
        
        marker.set("id",++marker_id);
        markers.push(marker);
        
       //alert(markers.length);
       //showLine(markers);
       // map.setCenter(markers[marker_id].getPosition());
        //map.setZoom(10);

        
      }

      function buildDays(){
      }

      function showLine(markers)
      {
       var coords = []; 
        for (var i = 0; i < markers.length; i++) {
          //alert(JSON.stringify(markers[i].position));
      var obj = JSON.parse(JSON.stringify(markers[i].position));
      var loc = new google.maps.LatLng(obj.lat, obj.lng);
      /*
      var geocoder = new google.maps.Geocoder();
      geocoder.geocode({'location': loc}, function(results, status) {
          if (status === 'OK') {
            if (results[0]) {
              map.setZoom(11);
            
              console.log(results[0].formatted_address);
              
            } else {
              console.log('No results found');
            }
          } else {
            console.log('Geocoder failed due to: ' + status);
          }
        });
        */
//alert(obj.lat);

    coords.push(loc);
    
    //console.log(geocoder);
        
        // alert(pos);
        }
    
        
        
        var signatureline = new google.maps.Polyline({
        path: coords,
          geodesic: true,
        strokeColor: "#FF00FF",
        strokeOpacity: 1.0,
        strokeWeight: 2});
      

        signatureline.setMap(map);
  
      }

      function deleteMarkers(){
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(null);
        }
      }

function ajaxGetSignature(userId)
{
  console.log('/drawsignature?userId='+userId);
  $.ajax({
			type : "GET",
      url : '/drawsignature',
      data: { 
    userId: userId
  },
			success: function(result){
        $.each(result, function(i, dot){
         // console.log(dot.name);
          var marker = new google.maps.Marker({
          position: dot,
          label:
          {text: dot.name,
          color: "#FFFFFF"},
          map: map,
          animation: google.maps.Animation.DROP,
          icon: {url:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png", scaledSize: new google.maps.Size(10, 10)},

        });
   
     
        marker.setVisible(true);
        markers.push(marker);
        
        //
				//	$('#getResultDiv .list-group').append(student.student + " " + student.age + "<br>")
        });
       showLine(markers);
      // var canvas = document.createElement("canvas");
       //document.body.appendChild(canvas);
    
    
       
        //var div = $("#map")[0];
        
   




        
        


/*

       FB.ui({method: 'feed',
picture: 'http://www.johnlennon.com/wp-content/uploads/2018/02/Walls_Bridges_1974_Gruen_JohnLennon-home-slider-min.jpg',
link: "http://www.johnlennon.com/",
caption: "www.gstatic.com",
description: "a small description associated with your post",
},  function(response) {
  if (response && response.post_id) {
  console.log('Post was published.');
  } else {
  console.log('Post was not published.');
  }
  });
  */
			},
			error : function(e) {
			
				console.log("ERROR: ", e);
			}
    });
    
 }
 
      function placeMarker(lat, lng,head, text,img) {
        //deleteMarkers();
        var location = new google.maps.LatLng(lat,lng);
        var marker = new google.maps.Marker({
          position: location,
          map: map
        });
        var content="";
        if(img!=null){
          content += "<img src='"+img+"' style='height:75px;'></img>";
        }
        content +=  "<h3>"+head+"</h3><h4>"+text+"</h4>";
        var infowindow = new google.maps.InfoWindow({
          content: content/*'Latitude: ' + location.lat() + '<br>Longitude: ' + location.lng()*/
          /*,pixelOffset: new google.maps.Size(200,0)*/
        });
        infowindow.open(map,marker);
        markers.push(marker);
      }

    </script>
  </body>
</html>